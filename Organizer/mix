using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Linq;
using wcerms.Data;
using wcerms.Models;

namespace wcerms.Pages.Organizer
{
    public class DashboardModel : PageModel
    {
        private readonly AppDbContext _context;

        public DashboardModel(AppDbContext context)
        {
            _context = context;
        }

        [BindProperty(SupportsGet = true)] public string Section { get; set; } = "Welcome";
        [BindProperty] public string EventName { get; set; } = "";
        [BindProperty] public DateTime EventDate { get; set; } = DateTime.Today;
        [BindProperty] public string? EventDescription { get; set; }
        [BindProperty] public string VenueName { get; set; } = "";
        [BindProperty] public string? VenueDetails { get; set; }
        [BindProperty] public string ResourceType { get; set; } = "";
        [BindProperty] public int Quantity { get; set; }

        public List<OrganizerBookingVM>? MyBookings { get; set; }
        public int TotalEvents { get; set; }
        public int TotalVenues { get; set; }
        public int TotalResources { get; set; }
        public int TotalBookings { get; set; }
        [BindProperty(SupportsGet = true)] public string? Search { get; set; }
        public List<OrganizerVenueVM>? AvailableVenues { get; set; }

        public void OnGet()
        {
            if (string.IsNullOrEmpty(Section))
                Section = "Welcome";

            if (Section == "MyBookings")
            {
                LoadBookings();
            }
            else if (Section == "Overview")
            {
                TotalEvents = _context.Events.Count();
                TotalVenues = _context.Venues.Count();
                TotalResources = _context.Resources.Count();
                TotalBookings = _context.Bookings.Count();
            }
            else if (Section == "CreateEvent")
            {
                AvailableVenues = _context.Venues
                    .Select(v => new OrganizerVenueVM
                    {
                        VenueId = v.VenueId,
                        Name = v.Name,
                        Location = v.Location,
                        Details = v.Details
                    }).ToList();
            }
        }

        public IActionResult OnPostCreateEvent()
        {
            if (EventDate < DateTime.Today)
            {
                TempData["Message"] = "Event date cannot be in the past.";
                return RedirectToPage("/Organizer/Dashboard", new { Section = "CreateEvent" });
            }

            if (string.IsNullOrWhiteSpace(EventName))
            {
                TempData["Message"] = "Please enter an event name.";
                return RedirectToPage("/Organizer/Dashboard", new { Section = "CreateEvent" });
            }

            var newEvent = new Event
            {
                Title = EventName,
                Description = EventDescription,
                start_datetime = EventDate,
                end_datetime = EventDate.AddHours(2),
                organizer_id = _context.Users.FirstOrDefault()
            };

            _context.Events.Add(newEvent);
            _context.SaveChanges();

            TempData["Message"] = $"Event '{EventName}' created successfully!";
            return RedirectToPage("/Organizer/Dashboard", new { Section = "CreateEvent" });
        }

        public IActionResult OnPostRequestVenue()
        {
            if (string.IsNullOrWhiteSpace(VenueName))
            {
                TempData["Message"] = "Venue name is required.";
                return RedirectToPage("/Organizer/Dashboard", new { Section = "RequestVenue" });
            }

            var venue = new Venue
            {
                Name = VenueName,
                Details = VenueDetails,
                Capacity = 0,
                Location = "To be confirmed"
            };

            _context.Venues.Add(venue);
            _context.SaveChanges();

            TempData["Message"] = $"Venue '{VenueName}' request submitted!";
            return RedirectToPage("/Organizer/Dashboard", new { Section = "RequestVenue" });
        }

        public IActionResult OnPostRequestResources()
        {
            if (string.IsNullOrWhiteSpace(ResourceType) || Quantity <= 0)
            {
                TempData["Message"] = "Please provide valid resource and quantity.";
                return RedirectToPage("/Organizer/Dashboard", new { Section = "RequestResources" });
            }

            var resource = new Resource
            {
                ResourceType = ResourceType,
                ResourceName = $"{ResourceType} Request",
                Quantity = Quantity
            };

            _context.Resources.Add(resource);
            _context.SaveChanges();

            TempData["Message"] = $"Resource request for '{ResourceType}' submitted!";
            return RedirectToPage("/Organizer/Dashboard", new { Section = "RequestResources" });
        }

        private void LoadBookings()
        {
            var query = from b in _context.Bookings
                        join e in _context.Events on b.EventId equals e.EventId
                        join v in _context.Venues on b.VenueId equals v.VenueId
                        select new OrganizerBookingVM
                        {
                            EventName = e.Title,
                            VenueName = v.Name,
                            Date = b.Date,
                            Status = b.Status
                        };

            if (!string.IsNullOrWhiteSpace(Search))
                query = query.Where(b => b.EventName.Contains(Search) || b.Status.Contains(Search));

            MyBookings = query.OrderByDescending(b => b.Date).ToList();

            foreach (var booking in MyBookings)
            {
                if (booking.Date < DateTime.Today && booking.Status != "Completed")
                    booking.Status = "Completed";
            }
        }

        public JsonResult OnGetEvents()
        {
            var events = _context.Events
                .Select(e => new
                {
                    id = e.EventId,
                    title = e.Title,
                    start = e.start_datetime,
                    end = e.end_datetime
                })
                .ToList();

            return new JsonResult(events);
        }
    }
}






@page
@model wcerms.Pages.Organizer.DashboardModel
@{
    ViewData["Title"] = "Organizer Dashboard";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">Organizer Dashboard</h2>

    @if (TempData["Message"] != null)
    {
        <div class="alert alert-info">@TempData["Message"]</div>
    }

    <div class="d-flex justify-content-center mb-3">
        <a asp-page="/Organizer/Dashboard" asp-route-Section="Overview" class="btn btn-primary mx-1">Overview</a>
        <a asp-page="/Organizer/Dashboard" asp-route-Section="CreateEvent" class="btn btn-primary mx-1">Create Event</a>
        <a asp-page="/Organizer/Dashboard" asp-route-Section="RequestVenue" class="btn btn-primary mx-1">Request Venue</a>
        <a asp-page="/Organizer/Dashboard" asp-route-Section="RequestResources" class="btn btn-primary mx-1">Request Resources</a>
        <a asp-page="/Organizer/Dashboard" asp-route-Section="MyBookings" class="btn btn-primary mx-1">My Bookings</a>
    </div>

    @if (Model.Section == "Overview")
    {
        <h4>System Overview</h4>
        <ul>
            <li>Total Events: @Model.TotalEvents</li>
            <li>Total Venues: @Model.TotalVenues</li>
            <li>Total Resources: @Model.TotalResources</li>
            <li>Total Bookings: @Model.TotalBookings</li>
        </ul>

        <div id="calendar"></div>
    }

    @if (Model.Section == "CreateEvent")
    {
        <h4>Create Event</h4>
        <form method="post" asp-page-handler="CreateEvent">
            <div class="form-group">
                <label>Event Name:</label>
                <input asp-for="EventName" class="form-control" />
            </div>

            <div class="form-group">
                <label>Date:</label>
                <input asp-for="EventDate" type="date" class="form-control" />
            </div>

            <div class="form-group">
                <label>Description:</label>
                <textarea asp-for="EventDescription" class="form-control"></textarea>
            </div>

            <div class="form-group">
                <label>Venue:</label>
                <select asp-for="VenueName" class="form-control">
                    <option value="">-- Select Venue --</option>
                    @if (Model.AvailableVenues != null)
                    {
                        foreach (var venue in Model.AvailableVenues)
                        {
                            <option value="@venue.Name">@venue.Name - @venue.Location</option>
                        }
                    }
                </select>
            </div>

            <button type="submit" class="btn btn-success mt-3">Create Event</button>
        </form>
    }

    @if (Model.Section == "RequestVenue")
    {
        <h4>Request New Venue</h4>
        <form method="post" asp-page-handler="RequestVenue">
            <div class="form-group">
                <label>Venue Name:</label>
                <input asp-for="VenueName" class="form-control" />
            </div>

            <div class="form-group">
                <label>Details:</label>
                <textarea asp-for="VenueDetails" class="form-control"></textarea>
            </div>

            <button type="submit" class="btn btn-success mt-3">Submit Venue Request</button>
        </form>
    }

    @if (Model.Section == "RequestResources")
    {
        <h4>Request Resources</h4>
        <form method="post" asp-page-handler="RequestResources">
            <div class="form-group">
                <label>Resource Type:</label>
                <select asp-for="ResourceType" class="form-control">
                    <option value="">-- Select Resource --</option>
                    <option value="Chairs">Chairs</option>
                    <option value="Tables">Tables</option>
                    <option value="Sound System">Sound System</option>
                    <option value="Projector">Projector</option>
                    <option value="Lights">Lights</option>
                </select>
            </div>

            <div class="form-group">
                <label>Quantity:</label>
                <input asp-for="Quantity" type="number" min="1" class="form-control" />
            </div>

            <button type="submit" class="btn btn-success mt-3">Submit Resource Request</button>
        </form>
    }

    @if (Model.Section == "MyBookings")
    {
        <h4>My Bookings</h4>
        <form method="get">
            <input type="text" name="Search" value="@Model.Search" placeholder="Search bookings..." class="form-control mb-3" />
        </form>

        @if (Model.MyBookings != null && Model.MyBookings.Any())
        {
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Venue</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var booking in Model.MyBookings)
                    {
                        <tr>
                            <td>@booking.EventName</td>
                            <td>@booking.VenueName</td>
                            <td>@booking.Date.ToShortDateString()</td>
                            <td>@booking.Status</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No bookings found.</p>
        }
    }

    @if (Model.Section == "Welcome")
    {
        <div class="text-center mt-5">
            <h4>Welcome to the Organizer Dashboard!</h4>
            <p>Select a section above to get started.</p>
        </div>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    if (calendarEl) {
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: '/Organizer/Dashboard?handler=Events'
        });
        calendar.render();
    }
});
</script>

